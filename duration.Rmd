---
title: "Consonant durations in onset"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: yes
    df_print: paged
---
  
  
  ```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data preprocessing

## Load required packages
```{r}
library(tidyr)
library(dplyr)
library(stringr)
library(lme4)
library(car)
library(visreg)
library(optimx)
library(lmerTest)
library(ggplot2)
library(optimx)
library(mgcv)
library(itsadug)
```



## Read data
```{r save data}
df <- readRDS("../data/modelling_data.rds")
```


### Tweak data
```{r}
# Change order of levels in cluster
df$cluster <- relevel(df$cluster, ref = "sp")
df$subj <- as.factor(df$subj)
df$dur <- as.numeric(df$dur)
df <- drop_na(df, dur)
df$condition <- relevel(df$condition, ref = "C")


df.onset.sp <- df[df$seg == "p" & df$cluster == "sp",]
df.onset.sm <- df[df$seg == "m",]
df.onset.sx <- df[df$seg == "X",]

df.onset <- rbind(df.onset.sp, df.onset.sm, df.onset.sx) # drop spr cluster
rm(df.onset.sp, df.onset.sm, df.onset.sx)

table(df.onset$subj, df.onset$trial)

df.onset.s <- df[df$seg == "s" & df$condition == "CC",]
```


# Duration of prevocalic consonant

## Hypothesis testing

Fitting first model:
```{r}
summary(m <- bam(dur ~ s(subj, bs='re'), data=df.onset, method = "ML"))
```

Adding condition as fixed effect:
```{r}
summary(m1 <- bam(dur ~ s(subj, bs='re') + condition, data=df.onset, method = "ML"))
compareML(m, m1)
```
Sign. improvement.

Adding group as fixed effect:
```{r}
summary(m2 <- bam(dur ~ s(subj, bs='re') + group + condition, data=df.onset, method = "ML"))
compareML(m1, m2)
```

Adding interaction as fixed effect:
```{r}
summary(m3 <- bam(dur ~ s(subj, bs='re') + group*condition, data=df.onset, method = "ML"))
compareML(m2, m3)
```
Sign. improvement.

Adding random slopes for condition:
```{r}
summary(m3REML <- bam(dur ~ s(subj, bs='re') + group + condition, data=df.onset, method = "REML"))
summary(m4REML <- bam(dur ~ s(subj, bs='re') + group + condition + s(subj, condition, bs = "re"), data=df.onset , method = "REML"))
compareML(m3REML, m4REML)
```
Sign. improvement.

Testing interaction again:
```{r}
summary(m5ML <- bam(dur ~ s(subj, bs='re') + group*condition + s(subj, condition, bs = "re"), data=df.onset, method = "ML"))
summary(m6ML <- bam(dur ~ s(subj, bs='re') + group + condition + s(subj, condition, bs = "re"), data=df.onset , method = "ML"))
compareML(m5ML, m6ML)
```
No need to include interaction.

Fit final model using REML:
```{r}
summary(m6REML <- bam(dur ~ s(subj, bs='re') + group + condition + s(subj, condition, bs = "re"), data=df.onset, method = "ML"))
```


## Exploratory

Add cluster
```{r}
summary(m7 <- bam(dur ~ s(subj, bs='re')  + condition + s(subj, condition, bs = "re"), data=df.onset, method = "ML"))
summary(m8 <- bam(dur ~ s(subj, bs='re') + cluster + condition + s(subj, condition, bs = "re"), data=df.onset, method = "ML"))
compareML(m7, m8)
```
Sign. improvement.

Adding condition*cluster as fixed effect:
```{r}
summary(m9 <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(subj, condition, bs = "re"), data=df.onset, method = "ML"))
compareML(m8, m9)
```
Sign. improv.

Add random slopes for cluster:
```{r}
summary(m9REML <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(subj, condition, bs = "re"), data=df.onset, method = "REML"))

summary(m10REML <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "REML"))

compareML(m9REML, m10REML)
```
Sign. improv.


Adding duration.tt fixed effect:
```{r}
df.onset$duration.tt <- df.onset$duration.tt - mean(df.onset$duration.tt) # center continues variable
summary(m10ML <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "ML"))

summary(m11ML <- bam(dur ~ s(subj, bs='re') + condition*cluster + s(duration.tt) + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "ML"))
compareML(m10ML, m11ML)

visreg(m11ML, "cluster", by = "condition", overlay = F, points = list(cex = 0.1), ylab = "duration prevocalic C (ms)", xlab = "pair")
```
Sign. improvement.


Adding recording.no fixed effect:
```{r}
summary(m12ML <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(recording.no) + s(duration.tt) + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "ML"))
compareML(m11ML, m12ML)


```
No improvement.


Adding gender as fixed effect:
```{r}
summary(m13ML <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(duration.tt) + gender + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "ML"))
compareML(m11ML, m13ML)
```
No sign. improvement.


Adding dialect as fixed effect:
```{r}
summary(m14ML <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(duration.tt) + dialect + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "ML"))
compareML(m11ML, m14ML)
```
No sign. improvement.


Adding age fixed effect:
```{r}
df.onset$age <- df.onset$age - mean(df.onset$age) # center continues variable
summary(m15ML <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(duration.tt) + s(age) + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "ML"))
compareML(m11ML, m15ML)
```
No sign. improvement.


Adding interaction cluster*condition as random slope:
```{r}
summary(m11REML <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(duration.tt) + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "REML"))

summary(m16REML <- bam(dur ~ s(subj, bs='re') + cluster*condition + s(duration.tt) + s(subj, cluster*condition, bs = "re"), data=df.onset, method = "REML"))

compareML(m11REML, m16REML)
```
No improvement.

Adding interaction group*cluster 
```{r}
summary(m17ML <- bam(dur ~ s(subj, bs='re') + group*cluster*condition + s(duration.tt) + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "ML"))
compareML(m11ML, m17ML)

# refit using REML
summary(m17REML <- bam(dur ~ s(subj, bs='re') + group*cluster*condition + s(duration.tt) + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "REML"))
plot_smooth(m17REML, view='duration.tt', ylab="duration", xlab="speech rate")
```





### Check assumptions
```{r}
gam.check(m17REML) # doesn't look very well, skewed right -> fit with loglink


summary(m17REML.loglink <- bam(dur ~ s(subj, bs='re') + group*cluster*condition + s(duration.tt) + s(subj, condition, bs = "re") + s(subj, cluster, bs = "re"), data=df.onset, method = "REML", family =Gamma(link=log)))

gam.check(m17REML.loglink) # still doesn't look good



visreg(m17REML.loglink, "cluster", by = "condition", overlay = T, points = list(cex = 0.1), ylab = "duration prevocalic C (ms)", xlab = "pair", cond=list(group = "CTRL"))
visreg(m17REML.loglink, "cluster", by = "condition", overlay = T, points = list(cex = 0.1), ylab = "duration prevocalic C (ms)", xlab = "pair", cond=list(group = "PD"))

```


# Check duration initial C in complex cluster


## Hypothesis testing

Fitting first model:
```{r}
summary(m <- bam(dur ~ s(subj, bs='re'), data=df.onset.s, method = "ML"))
```


Adding group as fixed effect:
```{r}
summary(m1 <- bam(dur ~ s(subj, bs='re') + group + s(duration.tt), data=df.onset, method = "ML"))
compareML(m, m1)
```
# Session info
```{r}
sessionInfo()
```

