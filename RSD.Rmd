---
title: "C-center RSD models"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: yes
    df_print: paged
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Preprocessing

## Load required packages
```{r}
library(tidyr)
library(dplyr)
library(stringr)
library(lme4)
library(car)
library(visreg)
library(optimx)
library(lmerTest)
library(emmeans)
library(ggplot2)
library(optimx)
library(mgcv)
library(itsadug)
```



## Read data
```{r save data}
df <- readRDS("../data/modelling_data_RSD.rds")
```


### Tweak data
```{r}
# Change order of levels in cluster
df$cluster <- factor(df$cluster, levels = c("sp", "sm", "sx", "spr"))
df <- subset(df, RSD != 0)

# create df without spr
df<- df[! df$cluster == "spr", ]
df <- droplevels(df)
levels(df$cluster)
```


# GAM models for RSD analysis

## Hypothesis testing

Fitting first model:
```{r}
summary(m <- bam(RSD ~ s(subj, bs='re'), data=df, method = "ML"))
```

Adding condition as fixed effect:
```{r}
summary(m1 <- bam(RSD ~ s(subj, bs='re') + condition, data=df, method = "ML"))
compareML(m,m1)
```
Sign. improvement.

Adding group as fixed effect:
```{r}
summary(m2 <- bam(RSD ~ s(subj, bs='re') + group + condition, data=df, method = "ML"))
compareML(m1,m2)
```
No improv.

Adding interaction
```{r}
summary(m3 <- bam(RSD ~ s(subj, bs='re') + group*condition, data=df, method = "ML"))
compareML(m2, m3)
```
No improv.

Adding random slopes for condition:
```{r}
summary(m2REML <- bam(RSD ~ s(subj, bs='re') + group + condition, data=df, method = "REML"))
summary(m4REML <- bam(RSD ~ s(subj, bs='re') + group + condition + s(subj, condition, bs="re"), data=df, method = "REML"))
compareML(m2REML,m4REML)
```
No improv.


### Exploratory analysis


Adding cluster as fixed effect:
```{r}
summary(m5 <- bam(RSD ~ s(subj, bs='re') + condition + cluster, data=df, method = "ML"))
compareML(m1,m5)
```
Sign. improvement.

Adding condition*cluster interaction:
```{r}
#create interaction
summary(m6 <- bam(RSD ~ s(subj, bs='re') + condition*cluster, data=df, method = "ML"))
compareML(m5,m6)
```
Sign. improvement.

Adding cluster as random effect:
```{r}
summary(m6REML <- bam(RSD ~ s(subj, bs='re') + condition*cluster, data=df, method = "REML"))

summary(m7REML <- bam(RSD ~ s(subj, bs='re') + condition*cluster + s(subj, cluster, bs="re"), data=df, method = "REML"))
compareML(m6REML, m7REML)
```
Sign. improvement.

Adding condition as random effect:
```{r}
summary(m8REML <- bam(RSD ~ s(subj, bs='re') + condition*cluster + s(subj, cluster, bs="re") + s(subj, condition, bs="re"), data=df, method = "REML"))
compareML(m7REML, m8REML)
```
Sign. improvement.


Add speech rate
```{r}
summary(m8ML <- bam(RSD ~ s(subj, bs='re') + condition*cluster + s(subj, cluster, bs="re") + s(subj, condition, bs="re"), data=df, method = "ML"))
summary(m9ML <- bam(RSD ~ s(subj, bs='re') + condition*cluster + s(mean.sr) + s(subj, cluster, bs="re") + s(subj, condition, bs="re"), data=df, method = "ML"))
compareML(m8ML, m9ML)
```
No improv.

Add gender
```{r}
summary(m11ML <- bam(RSD ~ s(subj, bs='re') + condition*cluster + gender + s(subj, cluster, bs="re") + s(subj, condition, bs="re"), data=df, method = "ML"))
compareML(m8ML, m11ML)

```
No sign. improvement.

Add dialect
```{r}
summary(m12ML <- bam(RSD ~ s(subj, bs='re') + condition*cluster + dialect + s(subj, cluster, bs="re") + s(subj, condition, bs="re"), data=df, method = "ML"))
compareML(m8ML, m12ML)
```
No sign. improvement.

Add age
```{r}
summary(m13ML <- bam(RSD ~ s(subj, bs='re') + condition*cluster + age + s(subj, cluster, bs="re") + s(subj, condition, bs="re"), data=df, method = "ML"))
compareML(m8ML, m13ML)
```
No sign. improvement.



### Checking assumptions
```{r}
summary(m8REML <- bam(RSD ~ s(subj, bs='re') + condition*cluster + s(subj, cluster, bs="re") + s(subj, condition, bs="re"), data=df, method = "REML"))
gam.check(m8REML) #looks okayish

summary(m8REML.loglink <- bam(RSD ~ s(subj, bs='re') + condition*cluster + s(subj, cluster, bs="re") + s(subj, condition, bs="re"), data=df, method = "REML", family =Gamma(link=log)))
gam.check(m8REML.loglink) #looks a bit better

summary(m8.REML_scat <- bam(RSD ~ s(subj, bs='re') + condition*cluster + s(subj, cluster, bs="re") + s(subj, condition, bs="re"), data=df, method = "fREML", family = "scat", discrete = T))
gam.check(m8.REML_scat)   

visreg(m8REML, "cluster", by = "condition", overlay = T, points = list(cex = 0.1), ylab = "relative standard deviation", xlab = "item pair")


visreg(m8REML, "cluster", by = "condition", overlay = T, points = list(cex = 0.1), ylab = "Relative standard deviation", xlab = "Item pair")
```

# Session info
```{r}
sessionInfo()
```

