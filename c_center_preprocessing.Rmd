---
title: "C-center preprocessing"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: yes
    df_print: paged
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Data check

## Load packages
```{r packages}
library("dplyr")
library("tidyr")
library("ggplot2")
library("stringr")
```

## Read data
```{r read}
df <- read.csv("c-center_7th_Aug.csv", header = TRUE, sep = ",")
load("../data/speech_rate.Rda")
```

## Merge mview output with speech rate dataframe
```{r}
df <- df %>%
  right_join(df_sr, by=c("subj", "fname"))
rm(df_sr)
```


## Tidy the data
```{r preprocess}
# extract info from filename, merge trialnumber and repetition
df<- df %>%
    separate(fname, c("project", "prompt", "block", "remove", "remove2", "trialno", "repetition"), sep = "_") %>%
    mutate(trial=str_c(trialno,repetition)) 
```

Drop unwanted columns.
```{r}
df <- df %>%
select(-c(project, remove, remove2, x1, x2, x3, x4, x5, x6, x7, y1, y2, y3, y4, y5, y6, y7, z1, z2, z3, z4, z5, z6, z7, v1, v2, v3, v4, v5, v6, v7, X.1, X.2, X.3, DOns, DTarg, DOff))
```

Create new variable recording.no to indicate the recording number (first recording, second recording etc..).
```{r}
trialno <- df %>% 
group_by(subj) %>% 
distinct(trial) %>% 
arrange(trial, by_group = TRUE) %>%
mutate(recording.no = 1:n()) %>% 
select(recording.no, everything()) %>% 
arrange(subj, recording.no)
```

Bind trialno with dataframe.
```{r}
df <- df %>% 
  inner_join(trialno, by = c("subj", "trial")) %>% 
  select(recording.no, everything()) %>% 
  arrange(subj, recording.no)
rm(trialno)
```

Create group variable.
```{r}
df$group <- ifelse((str_detect(df$subj, "CTRL")), "CTRL", "PD")
df$group <-  as.factor(df$group)
```

Create condition based on prompt.
```{r}
df$condition <- "C"
df$condition[df$prompt == "oma spat" | df$prompt == "opa Smat" |df$prompt == "opa schat" | df$prompt == "oma's prak"] <- "CC"
df$condition[df$prompt == "oma sprak"] <- "CCC"
df$condition <-  as.factor(df$condition)
```

Create cluster column.
```{r}
df$cluster[df$prompt == "oma spat" | df$prompt == "oma's pad"] <- "sp" 
df$cluster[df$prompt == "opa schat" | df$prompt == "opa's gat"] <- "sx" 
df$cluster[df$prompt == "opa Smat" | df$prompt == "opa's mat"] <- "sm" 
df$cluster[df$prompt == "oma sprak" | df$prompt == "oma's prak"] <- "spr" 
df$cluster <- as.factor(df$cluster)
levels(df$cluster)
```

Remove faulty segmentation, based on outlier column.
```{r}
df <- df[is.na(df$outl),]
```

Check whether the conditions are well coded and whether the segmentation involves the correct articulators.
```{r}
table(df$prompt, df$condition)
table(df$prompt, df$cluster)
table(df$seg, df$traj)
```

Remove unreliable /sx/ segmentation of PD25.
```{r}
df <- df[!(df$subj == "PD25" & df$cluster == "sx"),]
```


# Preparing data for rightedge analysis
Here we compute the durations between the offset of the vowel's preceding consonant and the onset of the vowel's following consonant (i.e. the anchor).

/sp/ environment
```{r sp}
# collect onset times coda /t/ (end of word)
onset.t <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "t") %>%
  select(subj, recording.no, prompt, block, condition, seg, group, cluster, duration.tt, duration.mt,  t3) %>%
  rename(t3.t = t3)

# collect offset times /p/ (gesture of interest), merge dataframes and time normalize (0,1) the offset of /p/
sp <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "p") %>%
  select(subj, recording.no, prompt, block, condition, seg, group, cluster, duration.tt, duration.mt,  t5) %>%
  rename(t5.p = t5) %>%
  inner_join(onset.t, by = c("subj", "recording.no", "prompt", "block", "condition", "group", "cluster", "duration.tt", "duration.mt")) %>%
  mutate(time.lag = t3.t-t5.p) 

  rm(onset.t)

# getting rid of NA's
sp <- na.omit(sp, cols="time.lag")

# plot
ggplot(sp[sp$group == "CTRL",], aes(x=subj, y=time.lag, fill=condition)) + geom_boxplot() + labs(title = "CTRL: /sp/", y = "Distance to anchor (ms)")
ggplot(sp[sp$group == "PD",], aes(x=subj, y=time.lag, fill=condition)) + geom_boxplot() + labs(title = "PD: /sp/", y = "Distance to anchor (ms)")
```

/sm/ environment
```{r sm}
# collect onset times coda /t/ (end of word)
onset.t <- df %>%
  filter(prompt == "opa Smat" | prompt == "opa's mat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "t") %>%
  select(subj, recording.no, prompt, block, condition, seg, group, cluster, duration.tt, duration.mt,  t3) %>%
  rename(t3.t = t3)

# collect offset times /m/ (gesture of interest), merge dataframes and time normalize (0,1) the offset of /m/
sm <- df %>%
  filter(prompt == "opa Smat" | prompt == "opa's mat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "m") %>%
  select(subj, recording.no, prompt, block, condition, seg, group, cluster, duration.tt, duration.mt,  t5) %>%
  rename(t5.m = t5) %>%
  inner_join(onset.t, by = c("subj", "recording.no", "prompt", "block", "condition", "group", "cluster", "duration.tt", "duration.mt")) %>%
  mutate(time.lag = t3.t-t5.m) 

  rm(onset.t)
  

# getting rid of NA's
sm <- na.omit(sm, cols="time.lag")

# plot
ggplot(sm[sm$group == "CTRL",], aes(x=subj, y=time.lag, fill=condition)) + geom_boxplot() + labs(title = "CTRL: /sm/", y = "Distance to anchor (ms)")
ggplot(sm[sm$group == "PD",], aes(x=subj, y=time.lag, fill=condition)) + geom_boxplot() + labs(title = "PD: /sm/", y = "Distance to anchor (ms)")
```

/sx/ environment
```{r sx}
# collect onset times coda /t/ (end of word)
onset.t <- df %>%
  filter(prompt == "opa schat" | prompt == "opa's gat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "t") %>%
  select(subj, recording.no, prompt, block, condition, seg, group, cluster, duration.tt, duration.mt,  t3) %>%
  rename(t3.t = t3)

# collect offset times /x/ (gesture of interest), merge dataframes and time normalize (0,1) the offset of /x/
sx <- df %>%
  filter(prompt == "opa schat" | prompt == "opa's gat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "X") %>%
  select(subj, recording.no, prompt, block, condition, seg, group, cluster, duration.tt, duration.mt,  t5) %>%
  rename(t5.x = t5) %>%
  inner_join(onset.t, by = c("subj", "recording.no", "prompt", "block", "condition", "group", "cluster", "duration.tt", "duration.mt")) %>%
  mutate(time.lag = t3.t-t5.x)  

  rm(onset.t)
  
# getting rid of NA's
sx <- na.omit(sx, cols="time.lag")

# plot
ggplot(sx[sx$group == "CTRL",], aes(x=subj, y=time.lag, fill=condition)) + geom_boxplot() + labs(title = "CTRL: /sx/", y = "Distance to anchor (ms)")
ggplot(sx[sx$group == "PD",], aes(x=subj, y=time.lag, fill=condition)) + geom_boxplot() + labs(title = "PD: /sx/", y = "Distance to anchor (ms)")
```

/spr/ environment
```{r spr}
# collect onset times coda /k/ (end of word)
onset.k <- df %>%
  filter(prompt == "oma sprak" | prompt == "oma's prak" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "k") %>%
  select(subj, recording.no, prompt, block, condition, seg, group, cluster, duration.tt, duration.mt,  t3) %>%
  rename(t3.k = t3)

# collect offset times /r/ (gesture of interest), merge dataframes and time normalize (0,1) the offset of /r/
spr <- df %>%
  filter(prompt == "oma sprak" | prompt == "oma's prak" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "r") %>%
  select(subj, recording.no, prompt, block, condition, seg, group, cluster, duration.tt, duration.mt,  t5) %>%
  rename(t5.r = t5) %>%
  inner_join(onset.k, by = c("subj", "recording.no", "prompt", "block", "condition", "group", "cluster", "duration.tt", "duration.mt")) %>%
  mutate(time.lag = t3.k-t5.r)  

  rm(onset.k)
  

# getting rid of NA's
spr <- na.omit(spr, cols="time.lag")

# plot
ggplot(spr[spr$group == "CTRL",], aes(x=subj, y=time.lag, fill=condition, na.rm = T)) + geom_boxplot() + labs(title = "CTRL: /spr/", y = "Distance to anchor (ms)")
ggplot(spr[spr$group == "PD",], aes(x=subj, y=time.lag, fill=condition, na.rm = T)) + geom_boxplot() + labs(title = "PD: /spr/", y = "Distance to anchor (ms)")
```

Merge clusters into new dataframe.
```{r merge rightedge}
df.rightedge <- rbind(sm, sp, sx, spr)
# df.rightedge <- unique(df.rightedge[,c("subj", "group", "condition","cluster","mean.lag.prompt.norm")])
rm(sm, sp, sx, spr)
```

## Plots
### Plots over all speakers
```{r plots rightedge}
dodge <- position_dodge(width = 0.9)

#right edge shift
ggplot(df.rightedge, aes(x=group, y=time.lag, fill=condition)) + geom_violin() + labs(title = "Over all clusters", y = "Distance to anchor") + geom_boxplot(width=.2, position = dodge)

#/sp/
ggplot(df.rightedge[df.rightedge$cluster == "sp",], aes(x=group, y=time.lag, fill=condition)) + geom_violin() + labs(title = "sp", y = "Lag (ms)") + geom_boxplot(width=.2, position = dodge)

#/sm/
ggplot(df.rightedge[df.rightedge$cluster == "sm",], aes(x=group, y=time.lag, fill=condition)) + geom_violin() + labs(title = "sm", y = "Lag (ms)") + geom_boxplot(width=.2, position = dodge)

#/sX/
ggplot(df.rightedge[df.rightedge$cluster == "sx",], aes(x=group, y=time.lag, fill=condition)) + geom_violin() + labs(title = "sx", y = "Lag (ms)") + geom_boxplot(width=.2, position = dodge)

#/spr/
ggplot(df.rightedge[df.rightedge$cluster == "spr",], aes(x=group, y=time.lag, fill=condition)) + geom_violin() + labs(title = "spr", y = "Lag (ms)") + geom_boxplot(width=.2, position = dodge)
```
### Plots per speakers

/sp/
```{r /sp/ plots per speaker}
ggplot(df.rightedge[df.rightedge$group == "CTRL" & df.rightedge$prompt != "oma's prak" & df.rightedge$cluster == "sp",], aes(x=subj, y=time.lag, fill=condition)) + labs(title = "/sp/, CTRL") + geom_boxplot()

ggplot(df.rightedge[df.rightedge$group == "PD" & df.rightedge$prompt != "oma's prak" & df.rightedge$cluster == "sp",], aes(x=subj, y=time.lag, fill=condition)) + labs(title = "/sp/, PD, ", y = "Lag (ms)") + geom_boxplot()
```

/sm/
```{r /sm/ plots per speaker}
ggplot(df.rightedge[df.rightedge$group == "CTRL" & df.rightedge$prompt != "oma's prak" & df.rightedge$cluster == "sm",], aes(x=subj, y=time.lag, fill=condition)) + labs(title = "/sm/, CTRL", y = "Lag (ms)") + geom_boxplot()

ggplot(df.rightedge[df.rightedge$group == "PD" & df.rightedge$prompt != "oma's prak" & df.rightedge$cluster == "sm",], aes(x=subj, y=time.lag, fill=condition)) + labs(title = "/sm/, PD", y = "Lag (ms)") + geom_boxplot()
```

/sx/
```{r /sx/ plots per speaker}
ggplot(df.rightedge[df.rightedge$group == "CTRL" & df.rightedge$prompt != "oma's prak" & df.rightedge$cluster == "sx",], aes(x=subj, y=time.lag, fill=condition)) + labs(title = "/sx/, CTRL", y = "Lag (ms)") + geom_boxplot()

ggplot(df.rightedge[df.rightedge$group == "PD" & df.rightedge$prompt != "oma's prak" & df.rightedge$cluster == "sx",], aes(x=subj, y=time.lag, fill=condition)) + labs(title = "/sx/, PD", y = "Lag (ms)") + geom_boxplot()
```

/spr/
```{r /spr/ plots per speaker}
ggplot(df.rightedge[df.rightedge$group == "CTRL" & df.rightedge$prompt != "oma's prak" & df.rightedge$cluster == "sp",], aes(x=subj, y=time.lag, fill=condition)) + labs(title = "/spr/, CTRL", y = "Lag (ms)") + geom_boxplot()

ggplot(df.rightedge[df.rightedge$group == "PD" & df.rightedge$prompt != "oma's prak" & df.rightedge$cluster == "sp",], aes(x=subj, y=time.lag, fill=condition)) + labs(title = "/spr/, PD", y = "Lag (ms)") + geom_boxplot()
```


# Preparing data for within cluster analysis

/sp/ CC lag
```{r sp CC lag}
# collect offset times /s/
offset.s <- df %>%
  filter(prompt == "oma spat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "s") %>%
  select(subj, recording.no, t5) %>%
  rename(t5.s = t5) 

# collect onset times /p/ and merge df's
sp.CC <- df %>%
  filter(prompt == "oma spat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "p") %>%
  select(subj, recording.no, prompt, block, condition, group, cluster, duration.tt, duration.mt,  t3) %>%
  rename(t3.p = t3) %>%
  inner_join(offset.s, by=c("subj", "recording.no")) %>%
  mutate(time.lag = t3.p-t5.s)

rm(offset.s)

# getting rid of NA's
sp.CC <- na.omit(sp.CC, cols="time.lag")

# plot
ggplot(sp.CC, aes(x=subj, y=time.lag, fill=group, na.rm = T)) + geom_boxplot() + labs(title = "CTRL: /sp/", y = "Lag between C's (ms)")
```

/sm/ CC lag
```{r sm CC lag}
# collect  offset times /s/
offset.s <- df %>%
  filter(prompt == "opa Smat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "s") %>%
  select(subj, recording.no, t5) %>%
  rename(t5.s = t5)
  
# collect offset times /m/
sm.CC <- df %>%
  filter(prompt == "opa Smat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "m") %>%
  select(subj, recording.no, prompt, block, condition, group, cluster, duration.tt, duration.mt,  t3) %>%
  rename(t3.m = t3)  %>%
  inner_join(offset.s, by=c("subj", "recording.no")) %>%
  mutate(time.lag = t3.m-t5.s)

rm(offset.s)

# getting rid of NA's
sm.CC <- na.omit(sm.CC, cols="time.lag")

# plot
ggplot(sm.CC, aes(x=subj, y=time.lag, fill=group, na.rm = T)) + geom_boxplot() + labs(title = "PD: /sm/", y = "Lag between C's (ms)")
```

/sx/ CC lag
```{r}
# collect offset times /s/
offset.s <- df %>%
  filter(prompt == "opa schat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "s") %>%
  select(subj, recording.no, t5) %>%
  rename(t5.s = t5)

# collect onset times /x/
sx.CC <- df %>%
  filter(prompt == "opa schat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "X") %>%
  select(subj, recording.no, prompt, block, condition, group, cluster, duration.tt, duration.mt,  t3) %>%
  rename(t3.x = t3)  %>%
  inner_join(offset.s, by=c("subj", "recording.no")) %>%
  mutate(time.lag = t3.x-t5.s)

rm(offset.s)

# getting rid of NA's
sx.CC <- na.omit(sx.CC, cols="time.lag")


# plot
ggplot(sx.CC, aes(x=subj, y=time.lag, fill=group, na.rm = T)) + geom_boxplot() + labs(title = "PD: /sx/", y = "Lag between C's (ms)")
```
/pr/ CC lag
```{r}
# collect offset times /s/
offset.p <- df %>%
  filter(prompt == "oma's prak") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "p") %>%
  select(subj, recording.no, t5) %>%
  rename(t5.p = t5)

# collect onset times /x/
pr.CC <- df %>%
  filter(prompt == "oma's prak") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "r") %>%
  select(subj, recording.no, prompt, block, condition, group, cluster, duration.tt, duration.mt,  t3) %>%
  rename(t3.r = t3)  %>%
  inner_join(offset.p, by=c("subj", "recording.no")) %>%
  mutate(time.lag = t3.r-t5.p)

rm(offset.p)

# getting rid of NA's
pr.CC <- na.omit(pr.CC, cols="time.lag")

# plot
ggplot(pr.CC, aes(x=subj, y=time.lag, fill=group, na.rm = T)) + geom_boxplot() + labs(title = "PD: /pr/", y = "Lag between C's (ms)")
```

/spr/ CC lag
```{r}
# collect normalized offset times /s/
offset.s <- df %>%
  filter(prompt == "oma sprak") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "s") %>%
  select(subj, recording.no, t5) %>%
  rename(t5.s = t5)  

# collect normalized offset times /r/
spr.CC <- df %>%
  filter(prompt == "oma sprak") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "r") %>%
  select(subj, recording.no, prompt, block, condition, group, cluster, duration.tt, duration.mt,  t3) %>%
  rename(t3.r = t3)  %>%
  inner_join(offset.s, by=c("subj", "recording.no")) %>%
  mutate(time.lag = t3.r-t5.s)

rm(offset.s)


# getting rid of NA's
spr.CC <- na.omit(spr.CC, cols="time.lag")


# plot
ggplot(spr.CC, aes(x=subj, y=time.lag, fill=group, na.rm = T)) + geom_boxplot() + labs(title = "CTRL: /spr/", y = "Lag between C's (ms)")
```

Merge.
```{r merge}
df.CC.lag<- rbind(sm.CC, sp.CC, sx.CC, pr.CC, spr.CC)
rm(sm.CC, sp.CC, sx.CC, pr.CC, spr.CC)
```


## Some plots
```{r plots}
ggplot(df.CC.lag, aes(x=condition, y=time.lag, fill=group)) + geom_violin() + labs(title = "CC lag all clusters", y = "Lag between C's") + geom_boxplot(width=.2, position = dodge)
ggplot(df.CC.lag[df.CC.lag$cluster == "sp",], aes(x=condition, y=time.lag, fill=group)) + geom_violin() + labs(title = "CC lag /sp/", y = "Lag between C's") + geom_boxplot(width=.2, position = dodge)
ggplot(df.CC.lag[df.CC.lag$cluster == "sm",], aes(x=condition, y=time.lag, fill=group)) + geom_violin() + labs(title = "CC lag /sm/", y = "Lag between C's") + geom_boxplot(width=.2, position = dodge)
ggplot(df.CC.lag[df.CC.lag$prompt == "oma's prak",], aes(x=condition, y=time.lag, fill=group)) + geom_violin() + labs(title = "CC /pr/", y = "Lag between C's") + geom_boxplot(width=.2, position = dodge)
ggplot(df.CC.lag[df.CC.lag$prompt == "oma sprak",], aes(x=condition, y=time.lag, fill=group)) + geom_violin() + labs(title = "CC lag /spr/", y = "Lag between C's") + geom_boxplot(width=.2, position = dodge)
```

# Preparing data for C-center analysis

## Calculate lag's for /sp/ 
```{r sp C-center}
# collect maxc time onset /p/ 
maxc.p <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "p") %>%
  rename(maxc.p = t4) %>%
  select(subj, prompt, recording.no, maxc.p)
  
# collect maxc time onset /s/
maxc.s <- df %>%
  filter(prompt == "oma spat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "s") %>%
  rename(maxc.s = t4) %>%
  select(subj, prompt, recording.no,  maxc.s) 

# calculate C-center
sp.c.center <- maxc.p %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  left_join(maxc.s, by=c("subj", "prompt", "recording.no")) %>%
  rowwise() %>%
  mutate(c.center = case_when(prompt == "oma's pad" ~ maxc.p, prompt == "oma spat" ~ mean(c(maxc.s, maxc.p)))) %>%
  select(subj, recording.no, c.center) 

rm(maxc.p, maxc.s)
```

Get rightedge /sp/ 
```{r}
# collect offset times /p/ 
sp.rightedge <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "p") %>%
  rename(rightedge = t5) %>%
  select(subj, recording.no, rightedge) 
```

Get anchor /t/ 
```{r}
# collect onset times coda /t/
sp.anchor <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "t") %>%
  rename(anchor = t3) %>%
  select(subj, recording.no, anchor) 
```

Merge and remove obsolete df's
```{r}
df.C.center.sp <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  left_join(sp.c.center, by =c("subj", "recording.no")) %>%
  left_join(sp.rightedge, by =c("subj", "recording.no")) %>%
  left_join(sp.anchor, by =c("subj", "recording.no"))

rm(sp.c.center, sp.rightedge, sp.anchor)
```


## Calculate lag's for /sm/ 
```{r sm C-center}
# collect maxc time onset /m/ 
maxc.m <- df %>%
  filter(prompt == "opa Smat" | prompt == "opa's mat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "m") %>%
  rename(maxc.m = t4) %>%
  select(subj, prompt, recording.no, maxc.m)
  
# collect maxc time onset /s/
maxc.s <- df %>%
  filter(prompt == "opa Smat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "s") %>%
  rename(maxc.s = t4) %>%
  select(subj, prompt, recording.no,  maxc.s) 

# calculate C-center
sm.c.center <- maxc.m %>%
  filter(prompt == "opa Smat" | prompt == "opa's mat" ) %>%
  left_join(maxc.s, by=c("subj", "prompt", "recording.no")) %>%
  rowwise() %>%
  mutate(c.center = case_when(prompt == "opa's mat" ~ maxc.m, prompt == "opa Smat" ~ mean(c(maxc.s, maxc.m)))) %>%
  select(subj, recording.no, c.center) 

rm(maxc.m, maxc.s)
```

Get rightedge /sm/ 
```{r}
# collect offset times /m/ 
sm.rightedge <- df %>%
  filter(prompt == "opa Smat" | prompt == "opa's mat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "m") %>%
  rename(rightedge = t5) %>%
  select(subj, recording.no, rightedge) 
```

Get velocity based rightedge /sm/ 
```{r}
# collect offset times /m/ 
sm.rightedge.vel <- df %>%
  filter(prompt == "opa Smat" | prompt == "opa's mat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "m") %>%
  rename(rightedge.vel = t6) %>%
  select(subj, recording.no, rightedge.vel) 
```

Get anchor /t/ 
```{r}
# collect onset times coda /t/
sm.anchor <- df %>%
  filter(prompt == "opa Smat" | prompt == "opa's mat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "t") %>%
  rename(anchor = t3) %>%
  select(subj, recording.no, anchor) 
```

Merge and remove obsolete df's
```{r}
df.C.center.sm <- df %>%
  filter(prompt == "opa Smat" | prompt == "opa's mat" ) %>%
  left_join(sm.c.center, by =c("subj", "recording.no")) %>%
  left_join(sm.rightedge, by =c("subj", "recording.no")) %>%
  left_join(sm.anchor, by =c("subj", "recording.no"))

rm(sm.c.center, sm.rightedge, sm.anchor)
```


## Calculate lag's for /sx/ 
```{r sx C-center}
# collect maxc time onset /x/ 
maxc.x <- df %>%
  filter(prompt == "opa schat" | prompt == "opa's gat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "X") %>%
  rename(maxc.x = t4) %>%
  select(subj, prompt, recording.no, maxc.x)
  
# collect maxc time onset /s/
maxc.s <- df %>%
  filter(prompt == "opa schat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "s") %>%
  rename(maxc.s = t4) %>%
  select(subj, prompt, recording.no,  maxc.s) 

# calculate C-center
sx.c.center <- maxc.x %>%
  filter(prompt == "opa schat" | prompt == "opa's gat" ) %>%
  left_join(maxc.s, by=c("subj", "prompt", "recording.no")) %>%
  rowwise() %>%
  mutate(c.center = case_when(prompt == "opa's gat" ~ maxc.x, prompt == "opa schat" ~ mean(c(maxc.s, maxc.x)))) %>%
  select(subj, recording.no, c.center) 

rm(maxc.x, maxc.s)
```

Get rightedge /sx/ 
```{r}
# collect offset times /x/ 
sx.rightedge <- df %>%
  filter(prompt == "opa schat" | prompt == "opa's gat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "X") %>%
  rename(rightedge = t5) %>%
  select(subj, recording.no, rightedge) 
```

Get anchor /t/ 
```{r}
# collect onset times coda /t/
sx.anchor <- df %>%
  filter(prompt == "opa schat" | prompt == "opa's gat" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "t") %>%
  rename(anchor = t3) %>%
  select(subj, recording.no, anchor) 
```

Merge and remove obsolete df's
```{r}
df.C.center.sx <- df %>%
  filter(prompt == "opa schat" | prompt == "opa's gat" ) %>%
  left_join(sx.c.center, by =c("subj", "recording.no")) %>%
  left_join(sx.rightedge, by =c("subj", "recording.no")) %>%
  left_join(sx.anchor, by =c("subj", "recording.no"))

rm(sx.c.center, sx.rightedge, sx.anchor)
```


## Calculate lag's for /spr/ 
```{r spr C-center}
# collect maxc time onset /r/ 
maxc.r <- df %>%
  filter(prompt == "oma sprak" | prompt == "oma's prak" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "r") %>%
  rename(maxc.r = t4) %>%
  select(subj, prompt, recording.no, maxc.r)
  
# collect maxc time onset /p/
maxc.p <- df %>%
  filter(prompt == "oma sprak") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "p") %>%
  rename(maxc.p = t4) %>%
  select(subj, prompt, recording.no,  maxc.p) 

# collect maxc time onset /s/
maxc.s <- df %>%
  filter(prompt == "oma sprak") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "s") %>%
  rename(maxc.s = t4) %>%
  select(subj, prompt, recording.no,  maxc.s) 

# calculate C-center
spr.c.center <- maxc.r %>%
  filter(prompt == "oma sprak" | prompt == "oma's prak" ) %>%
  left_join(maxc.s, by=c("subj", "prompt", "recording.no")) %>%
  left_join(maxc.p, by=c("subj", "prompt", "recording.no")) %>%
  rowwise() %>%
  mutate(c.center = case_when(prompt == "oma's prak" ~ maxc.r, prompt == "oma sprak" ~ mean(c(maxc.s, maxc.p, maxc.r)))) %>%
  select(subj, recording.no, c.center) 

rm(maxc.r, maxc.s, maxc.p)
```

Get rightedge /spr/ 
```{r}
# collect offset times /r/ 
spr.rightedge <- df %>%
  filter(prompt == "oma sprak" | prompt == "oma's prak" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "r") %>%
  rename(rightedge = t5) %>%
  select(subj, recording.no, rightedge) 
```

Get anchor /k/ 
```{r}
# collect onset times coda /t/
spr.anchor <- df %>%
  filter(prompt == "oma sprak" | prompt == "oma's prak" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "k") %>%
  rename(anchor = t3) %>%
  select(subj, recording.no, anchor) 
```

Merge and remove obsolete df's
```{r}
df.C.center.spr <- df %>%
  filter(prompt == "oma sprak" | prompt == "oma's prak" ) %>%
  left_join(spr.c.center, by =c("subj", "recording.no")) %>%
  left_join(spr.rightedge, by =c("subj", "recording.no")) %>%
  left_join(spr.anchor, by =c("subj", "recording.no"))

rm(spr.c.center, spr.rightedge, spr.anchor)
```


## Merge C-center df's
```{r}
df.C.center <- rbind(df.C.center.sp, df.C.center.sm, df.C.center.sx, df.C.center.spr)
rm(df.C.center.sp, df.C.center.sm, df.C.center.sx, df.C.center.spr)

df.C.center <- df.C.center  %>%
    rowwise() %>%
    mutate(c.center.lag = anchor - c.center) %>%
    mutate(rightedge.lag = anchor - rightedge) 

```


## Some plots
### Per group

/sm/
```{r}

ggplot(df.C.center[df.C.center$cluster == 'sm',], aes(x=group, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/sm/, c-center", y = "Lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sm',], aes(x=group, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/sm/, rightedge", y = "Lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)
```

/sp/
```{r}
ggplot(df.C.center[df.C.center$cluster == 'sp',], aes(x=group, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/sp/, c-center", y = "Lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sp',], aes(x=group, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/sp/, rightedge", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)
```

/sx/
```{r}
ggplot(df.C.center[df.C.center$cluster == 'sx',], aes(x=group, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/sx/, c-center", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sx',], aes(x=group, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/sx/, rightedge", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

```

/spr/
```{r}
ggplot(df.C.center[df.C.center$cluster == 'spr',], aes(x=group, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/spr/, c-center", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'spr',], aes(x=group, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/spr/, rightedge", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)
```


### Per individual

/sm/
```{r}
ggplot(df.C.center[df.C.center$cluster == 'sm' & df.C.center$group == 'CTRL',], aes(x=subj, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/sm/, c-center, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sm' & df.C.center$group == 'CTRL',], aes(x=subj, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/sm/, rightedge, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sm' & df.C.center$group == 'PD',], aes(x=subj, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/sm/, c-center, PD", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sm' & df.C.center$group == 'PD',], aes(x=subj, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/sm/, rightedge, PD", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)
```

/sp/
```{r}

ggplot(df.C.center[df.C.center$cluster == 'sp' & df.C.center$group == 'CTRL',], aes(x=subj, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/sp/, c-center, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge )+ ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sp' & df.C.center$group == 'CTRL',], aes(x=subj, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/sp/, rightedge, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sp' & df.C.center$group == 'PD',], aes(x=subj, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/sp/, c-center, PD", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sp' & df.C.center$group == 'PD',], aes(x=subj, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/sp/, rightedge, PD", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)
```

/sx/
```{r}

ggplot(df.C.center[df.C.center$cluster == 'sx' & df.C.center$group == 'CTRL',], aes(x=subj, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/sx/, c-center, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge )+ ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sx' & df.C.center$group == 'CTRL',], aes(x=subj, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/sx/, rightedge, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sx' & df.C.center$group == 'PD',], aes(x=subj, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/sx/, c-center, PD", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'sx' & df.C.center$group == 'PD',], aes(x=subj, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/sx/, rightedge, PD", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)
```

/spr/
```{r}

ggplot(df.C.center[df.C.center$cluster == 'spr' & df.C.center$group == 'CTRL',], aes(x=subj, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/spr/, c-center, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge )+ ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'spr' & df.C.center$group == 'CTRL',], aes(x=subj, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/spr/, rightedge, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'spr' & df.C.center$group == 'PD',], aes(x=subj, y=c.center.lag, fill=condition)) + geom_violin() + labs(title = "/spr/, c-center, PD", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)

ggplot(df.C.center[df.C.center$cluster == 'spr' & df.C.center$group == 'PD',], aes(x=subj, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "/spr/, rightedge, PD", y = "lag") + geom_boxplot(width=.2, position = dodge) + ylim(80, 350)
```

# Preparing data for c-center analysed based on velocity

## Calculate lag's for /sp/ 
```{r sp vel C-center}
# collect peak velocity time onset /p/ 
peakvel.p <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "p") %>%
  rename(peakvel.p = t2) %>%
  select(subj, prompt, recording.no, peakvel.p)
  
# collect peak velocity time onset /s/
peakvel.s <- df %>%
  filter(prompt == "oma spat") %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "s") %>%
  rename(peakvel.s = t6) %>%
  select(subj, prompt, recording.no,  peakvel.s) 

# calculate C-center
sp.c.center.vel <- peakvel.p %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  left_join(peakvel.s, by=c("subj", "prompt", "recording.no")) %>%
  rowwise() %>%
  mutate(c.center.vel = case_when(prompt == "oma's pad" ~ peakvel.p, prompt == "oma spat" ~ mean(c(peakvel.s, peakvel.p)))) %>%
  select(subj, recording.no, c.center.vel) 

rm(peakvel.p, peakvel.s)
```

Get rightedge /sp/ 
```{r}
# collect offset times /p/ 
sp.rightedge.vel <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "p") %>%
  rename(rightedge.vel = t6) %>%
  select(subj, recording.no, rightedge.vel) 
```

Get anchor /t/ 
```{r}
# collect onset times coda /t/
sp.anchor.vel <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  group_by(subj) %>%
  group_by(recording.no) %>%
  filter(seg == "t") %>%
  rename(anchor = t3) %>%
  select(subj, recording.no, anchor) 
```

Merge and remove obsolete df's
```{r}
df.C.center.sp.vel <- df %>%
  filter(prompt == "oma spat" | prompt == "oma's pad" ) %>%
  left_join(sp.c.center.vel, by =c("subj", "recording.no")) %>%
  left_join(sp.rightedge.vel, by =c("subj", "recording.no")) %>%
  left_join(sp.anchor.vel, by =c("subj", "recording.no"))

rm(sp.c.center.vel, sp.rightedge.vel, sp.anchor.vel)
```

Calculate C-center lag
```{r}
df.C.center.sp.vel <- df.C.center.sp.vel  %>%
    rowwise() %>%
    mutate(c.center.lag.vel = anchor - c.center.vel) %>%
    mutate(rightedge.lag.vel = anchor - rightedge.vel) 

ggplot(df.C.center.sp.vel[df.C.center.sp.vel$group == 'CTRL',], aes(x=subj, y=c.center.lag.vel, fill=condition)) + geom_violin() + labs(title = "/sp/, c-center, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge ) + ylim(80, 350)

ggplot(df.C.center.sp.vel[df.C.center.sp.vel$group == 'PD',], aes(x=subj, y=c.center.lag.vel, fill=condition)) + geom_violin() + labs(title = "/sp/, c-center, PD", y = "lag") + geom_boxplot(width=.2, position = dodge ) + ylim(80, 350)

ggplot(df.C.center.sp.vel[df.C.center.sp.vel$group == 'CTRL',], aes(x=subj, y=rightedge.lag.vel, fill=condition)) + geom_violin() + labs(title = "/sp/, rightedge, CTRL", y = "lag") + geom_boxplot(width=.2, position = dodge ) + ylim(80, 350)

ggplot(df.C.center.sp.vel[df.C.center.sp.vel$group == 'PD',], aes(x=subj, y=rightedge.lag.vel, fill=condition)) + geom_violin() + labs(title = "/sp/, rightedge, PD", y = "lag") + geom_boxplot(width=.2, position = dodge ) + ylim(80, 350)

```

# Save data
```{r save}
#add meta_data

setwd("/Users/45598770/Documents/analysis")
df_meta <- read.csv("metadata.csv", header = TRUE, sep = ",")
df_meta$gender <- as.factor(df_meta$gender)
df.rightedge <-  merge(df.rightedge, df_meta, by="subj")
df.CC.lag <-  merge(df.CC.lag, df_meta, by="subj")
rm(df_meta)

# Set variables that consist of most datapoints as reference variables
df.rightedge$gender <- relevel(df.rightedge$gender, ref = "M")
df.rightedge$group <- relevel(df.rightedge$group, ref = "CTRL")
df.rightedge$dialect <- relevel(df.rightedge$dialect, ref = "Rest")

# Set variables that consist of most datapoints as reference variables
df.CC.lag$gender <- relevel(df.CC.lag$gender, ref = "M")
df.CC.lag$group <- relevel(df.CC.lag$group, ref = "CTRL")
df.CC.lag$dialect <- relevel(df.CC.lag$dialect, ref = "Rest")

save(df.rightedge, file="modelling_data_rightedge.Rda")
save(df.CC.lag, file="modelling_data_CC.Rda")
```

