---
title: "C-center models"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: yes
    df_print: paged
---


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Load required packages
```{r}
library("tidyr")
library("dplyr")
library("stringr")
library("lme4")
library("car")
library("visreg")
library("optimx")
library("lmerTest")
library("emmeans")
library("ggplot2")
library("optimx")
library("mgcv")
library("itsadug")
library("car")
```

# Introduction


## Read data
```{r save data}
df <- readRDS("../data/modelling_data_CC.rds")
```

## Clean data
Remove all the rows that have NA in the dependent variable and drop 'empty' levels, convert variables to factors and create trimmed dataset.
```{r remove NA}
df$subj <- as.factor(df$subj)

df <- df[complete.cases(df$time.lag.norm),]
df <- droplevels(df)

# Sort data
df <- df[order(df$subj, df$recording.no),]

# convert to factors/numeric
df$prompt <- as.factor(df$prompt)
df$condition <- as.factor(df$condition)

# remove all the recordings without a speech rate measure:
# df <- df %>% drop_na(duration.tt)

# remove participants with only a few datapoints
#remove <- c("PD19", "CTRL19")
#df.trim <- df[! df$subj %in% remove, ]
#df.trim <- droplevels(df.trim)


# create df without sx
#df.trim <- df.trim[! df.trim$cluster == "sx", ]
#df.trim <- droplevels(df.trim)
#levels(df.trim$cluster)

# create df without spr
df.nospr <- df[! df$cluster == "spr", ]
df.nospr <- droplevels(df.nospr)
levels(df.nospr$cluster)
df.nospr$cluster <- relevel(df.nospr$cluster, ref = "sm")



# merge /sm/ and /sp/
df.nospr$poa <- ifelse(df.nospr$cluster == "sx","C2lingual","C2bilabial")
df.nospr$poa <- as.factor(df.nospr$poa)
table(df.nospr$poa, df.nospr$cluster)


```







# Check correlations C1/C2 with IPI

## Hypothesis testing
Create one var for duration of C1/C2
```{r}
df.nospr <- df.nospr %>%
  gather(whichC, durationC, dur.C1.norm, dur.C2.norm) %>%
  arrange(subj, group, recording.no)

df.nospr$whichC <- as.factor(df.nospr$whichC)

#df.nospr$durationC <- df.nospr$durationC - mean(df.nospr$durationC) # center continues variable
df.nospr$cluster <- relevel(df.nospr$cluster, ref = "sx")
df.nospr$whichC <- relevel(df.nospr$whichC, ref = "dur.C2.norm")
```


Base model.
```{r}
summary(durC_m <- bam(durationC ~ s(subj,bs='re'), data = df.nospr, method = "ML"))
```

```{r}
summary(durC_m1 <- bam(durationC ~ whichC*time.lag.norm + s(subj,bs='re'), data = df.nospr, method = "ML"))
compareML(durC_m, durC_m1)
```
Improvement.

```{r}
summary(durC_m2 <- bam(durationC ~ whichC*time.lag.norm + group + s(subj,bs='re'), data = df.nospr, method = "ML"))
compareML(durC_m1, durC_m2)
```
No improvement, but keep it in as it's the hypothesis model.


```{r}
summary(durC_m3 <- bam(durationC ~ whichC*time.lag.norm + group*whichC + s(subj,bs='re'), data = df.nospr, method = "ML"))
compareML(durC_m2, durC_m3)
```
No improvement.

```{r}
summary(durC_m4 <- bam(durationC ~ whichC*time.lag.norm + group*whichC + group*time.lag.norm + s(subj,bs='re'), data = df.nospr, method = "ML"))
compareML(durC_m3, durC_m4)
```
No improvement.

Add by subject random slopes for durationC
```{r}
summary(durC_m2.REML <- bam(durationC ~ whichC*time.lag.norm + group*whichC + s(subj,bs='re'), data = df.nospr, method = "REML"))
summary(durC_m5.REML <- bam(durationC ~ whichC*time.lag.norm + group*whichC + s(subj,bs='re')+ s(subj, whichC, bs="re"), data = df.nospr, method = "REML"))
compareML(durC_m2.REML, durC_m5.REML)
```
Improvement.

Add by subject random slopes for time.lag.norm
```{r}
summary(durC_m6.REML <- bam(durationC ~ whichC*time.lag.norm + group*whichC + s(subj,bs='re') + s(subj, whichC, bs="re")+ s(subj, time.lag.norm, bs="re"), data = df.nospr, method = "REML"))
```
Improvement.

Add group to interaction:
```{r}
summary(durC_m6.ML <- bam(durationC ~ whichC*time.lag.norm + whichC*group + s(subj,bs='re') + s(subj, whichC, bs="re")+ s(subj, time.lag.norm, bs="re"), data = df.nospr, method = "ML"))
summary(durC_m7.ML <- bam(durationC ~ whichC*time.lag.norm*group + s(subj,bs='re') + s(subj, whichC, bs="re") + s(subj, time.lag.norm, bs="re"), data = df.nospr, method = "ML"))
compareML(durC_m6.ML, durC_m7.ML)
```
No improv.

Check if we really need whichC x group interaction
```{r}
summary(durC_m8.ML <- bam(durationC ~ whichC*time.lag.norm + group + s(subj,bs='re') + s(subj, whichC, bs="re")+ s(subj, time.lag.norm, bs="re"), data = df.nospr, method = "ML"))
compareML(durC_m6.ML, durC_m8.ML)
```
We don't need it.

## Exploraratory testing

Add cluster:
```{r}
summary(durC_m6.ML <- bam(durationC ~ whichC*time.lag.norm + s(subj,bs='re') + s(subj, whichC, bs="re")+ s(subj, time.lag.norm, bs="re"), data = df.nospr, method = "ML"))
summary(durC_m7.ML <- bam(durationC ~ whichC*time.lag.norm + cluster + s(subj,bs='re') + s(subj, whichC, bs="re")+ s(subj, time.lag.norm, bs="re"), data = df.nospr, method = "ML"))
compareML(durC_m6.ML, durC_m7.ML)
```
Improvement.

Add cluster to interaction:
```{r}
summary(durC_m7.inter.ML <- bam(durationC ~ whichC*time.lag.norm*cluster + s(subj,bs='re') + s(subj, whichC, bs="re")+ s(subj, time.lag.norm, bs="re"), data = df.nospr, method = "ML"))
compareML(durC_m7.ML, durC_m7.inter.ML)
```
Improvement.

Add speech rate smooth.
```{r}
summary(durC_m8.ML <- bam(durationC ~ whichC*time.lag.norm*cluster + s(duration.tt) + s(subj,bs='re') + s(subj, whichC, bs="re")+ s(subj, time.lag.norm, bs="re"), data = df.nospr, method = "ML"))
compareML(durC_m7.inter.ML, durC_m8.ML)
```
No improv.


Add by subject slopes for cluster.
```{r}
summary(durC_m7.REML <- bam(durationC ~ whichC*time.lag.norm*cluster + s(subj,bs='re') + s(subj, whichC, bs="re") + s(subj, time.lag.norm, bs="re"), data = df.nospr, method = "REML"))
summary(durC_m9.REML <- bam(durationC ~ whichC*time.lag.norm*cluster + s(subj,bs='re') + s(subj, whichC, bs="re") + s(subj, time.lag.norm, bs="re")+  s(subj, cluster, bs="re"), data = df.nospr, method = "REML"))
compareML(durC_m6.REML, durC_m9.REML)
```
Improvement.

Take out slopes for time.lag.norm, since it is not sign. anymore.
```{r}
summary(durC_m10.REML <- bam(durationC ~ whichC*time.lag.norm*cluster + s(subj,bs='re') + s(subj, whichC, bs="re") +  s(subj, cluster, bs="re"), data = df.nospr, method = "REML"))
```


Add gender:
```{r}
summary(durC_m10.ML <- bam(durationC ~ whichC*time.lag.norm*cluster + s(subj,bs='re') + s(subj, whichC, bs="re") +  s(subj, cluster, bs="re"), data = df.nospr, method = "ML"))
summary(durC_m11.ML <- bam(durationC ~ whichC*time.lag.norm*cluster +gender + s(subj,bs='re') + s(subj, whichC, bs="re") +  s(subj, cluster, bs="re"), data = df.nospr, method = "ML"))
compareML(durC_m10.ML, durC_m11.ML)
```
No sign.

Add trial:
```{r}
summary(durC_m12.ML <- bam(durationC ~ whichC*time.lag.norm*cluster + s(recording.no) + s(subj,bs='re') + s(subj, whichC, bs="re") +  s(subj, cluster, bs="re"), data = df.nospr, method = "ML"))
compareML(durC_m10.ML, durC_m12.ML)
```
Improvement.

Add age:
```{r}
summary(durC_m13.ML <- bam(durationC ~ whichC*time.lag.norm*cluster + s(age) + s(recording.no) + s(subj,bs='re') + s(subj, whichC, bs="re") +  s(subj, cluster, bs="re"), data = df.nospr, method = "ML"))
compareML(durC_m12.ML, durC_m13.ML)
```
No improvement.

Add dialect:
```{r}
summary(durC_m14.ML <- bam(durationC ~ whichC*time.lag.norm*cluster + dialect + s(recording.no) + s(subj,bs='re') + s(subj, whichC, bs="re") +  s(subj, cluster, bs="re"), data = df.nospr, method = "ML"))
compareML(durC_m12.ML, durC_m14.ML)
```
No improvement.

Check assumptions
```{r}
summary(durC_m12.REML <- bam(durationC ~ whichC*time.lag.norm*cluster + s(recording.no) + s(subj,bs='re') + s(subj, whichC, bs="re") +  s(subj, cluster, bs="re"), data = df.nospr, method = "REML"))

gam.check(durC_m12.REML) # looks crappy


summary(durC_m12.REML.loglink <- bam(durationC ~ whichC*time.lag.norm*cluster + s(recording.no) + s(subj,bs='re') + s(subj, whichC, bs="re") +  s(subj, cluster, bs="re"), data = df.nospr, method = "REML", family =Gamma(link=log)))

#take by-subject random slopes for cluster out, since they not signficant anymore:
summary(durC_m12.REML.loglink2 <- bam(durationC ~ whichC*time.lag.norm*cluster + s(recording.no) + s(subj,bs='re') + s(subj, whichC, bs="re"), data = df.nospr, method = "REML", family =Gamma(link=log)))

#check if we really need smooth for recording no:
summary(durC_m12.ML.loglink2 <- bam(durationC ~ whichC*time.lag.norm*cluster + s(recording.no) + s(subj,bs='re') + s(subj, whichC, bs="re"), data = df.nospr, method = "REML", family =Gamma(link=log)))

summary(durC_m12.ML.loglink3 <- bam(durationC ~ whichC*time.lag.norm*cluster + s(subj,bs='re') + s(subj, whichC, bs="re"), data = df.nospr, method = "REML", family =Gamma(link=log)))
compareML(durC_m12.ML.loglink2, durC_m12.ML.loglink3)
# not needed


gam.check(durC_m12.ML.loglink3) # looks OK

df.nospr$whichC <- str_replace(df.nospr$whichC, "dur.C1.norm", "C1")
df.nospr$whichC <- str_replace(df.nospr$whichC, "dur.C2.norm", "C2")


visreg(durC_m12.REML, "time.lag.norm", by = "whichC", overlay = F, points = list(cex = 0.1), gg = TRUE, cond=list(cluster = 'sp')) + theme_bw() # not clear

visreg(durC_m12.ML.loglink3, "time.lag.norm", by = "whichC", overlay = F, points = list(cex = 0.1), xlab = "normalized IPI", ylab = "normalized duration of C", gg = TRUE, cond=list(cluster = 'sp')) + theme_bw() # not clear
visreg(durC_m12.ML.loglink3, "time.lag.norm", by = "whichC", overlay = F, points = list(cex = 0.1), xlab = "normalized IPI", ylab = "normalized duration of C", gg = TRUE, cond=list(cluster = 'sm')) + theme_bw() # not clear

visreg(durC_m12.ML.loglink3, "time.lag.norm", by = "whichC", overlay = F, points = list(cex = 0.1), xlab = "normalized IPI", ylab = "normalized duration of C", gg = TRUE, cond=list(cluster = 'sx')) + theme_bw() # not clear

```
# Session info
```{r}
sessionInfo()
```

