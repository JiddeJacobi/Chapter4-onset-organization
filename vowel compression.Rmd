---
title: "Vowel compression"
output: 
  html_document: 
    number_sections: yes
    toc: yes
    toc_float: yes
    df_print: paged
---
  
```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

  # Load required packages
```{r}
library("tidyr");
library("plyr");
library("dplyr");
library("ggplot2");
library("lme4");
library("visreg");
library("mgcv");
library("itsadug");
```

# Introduction 
From the c-center hypothesis it follows that onsets are coordinated inphase with the following vowel, meaning that they are initiated roughly around the same time. On the other hand, multiple consonants in an onset are also coordinated antiphase with each other (i.e. sequential initiation). To cope with these competing relations, the leftmost C gets shifted towards the left and the rightmost C gets shifted towards the right (with respect to the following vowel) in complex onsets. In this way, the average onset of the two C's is still initiated at the same time as the vowel, whereas they are also still coordinated in an antiphase relation with each other. Our hypothesis is that PD patients will show a stronger preference for the inphase relationship, coming at the cost of the antiphase relationship. In our data we've included three singular onsets /p/, /m/ and /x/ and four complex onsets: /sp/, /sm/, /sx/ and /spr/. The variable 'rightedge.lag' is the time normalized (on a 0-1 scale) lag between consonant and vowel. 

## Read data
```{r save data}
df <- readRDS("../data/modelling_C_center.rds")
```

## Convert factors and subset data
```{r remove NA}
# convert to factors/numeric:
df$condition <- as.factor(df$condition)
df$subj <- as.factor(df$subj)

# remove all the recordings without a speech rate measure:
df <- df %>% drop_na(duration.tt)

# center duration.tt, so it's easier to interpret.
df$duration.tt.c <- scale(df$duration.tt, scale = F)

# Change order of levels in cluster
df$cluster <- factor(df$cluster, levels = c("sp", "sm", "sx", "spr"))

# Sort data
df <- df[order(df$subj, df$recording.no),]

# Rename CTRL
df$group <- revalue(df$group, c("CTRL"="typical"))

# create df without spr:
df.nospr <- df[! df$cluster == "spr", ]
df.nospr <- droplevels(df.nospr)
levels(df.nospr$cluster)

table(df.nospr$subj, df.nospr$prompt)
```


# GAM modelsfor rightward shift rightmost C
In a CCV complex onset the rightmost C in the onset should show a rightward shift towards the vowel in comparison to the C in a CV onset. We hypothesize that this shift may be less pronounced for the patient group, as they may show a stronger preference for inphase coordination. In this analysis we compare /sp/ to /p/, /sm/ to /m/, /sx/ to /x/ and /spr/ to /pr/. As a start, I've included the 'cluster' variable and the 'condition' (simple vs. complex onset) variable.

## Some plots
```{r}
dodge = .5

#right edge shift
ggplot(df.nospr, aes(x=group, y=rightedge.lag, fill=condition)) + geom_violin() + labs(title = "Over all clusters", y = "Distance to anchor")
dodge <- position_dodge(width = 0.9)

ggplot(df.nospr[df.nospr$cluster == "sp",], aes(x=group, y=rightedge.lag, fill=condition)) + geom_violin(trim=FALSE) + labs(title = "/sp/", y = "Distance to anchor") + geom_boxplot(width=.2, position = dodge) 

ggplot(df.nospr[df.nospr$cluster == "sm",], aes(x=group, y=rightedge.lag, fill=condition)) + geom_violin(trim=FALSE) + labs(title = "/sm/", y = "Distance to anchor") + geom_boxplot(width=.2, position = dodge) 

ggplot(df.nospr[df.nospr$cluster == "sx",], aes(x=group, y=rightedge.lag, fill=condition)) + geom_violin(trim=FALSE) + labs(title = "/sx/", y = "Distance to anchor") + geom_boxplot(width=.2, position = dodge) 
```

## Hypothesis testing

```{r}
summary(m <- bam(rightedge.lag ~ s(subj, bs='re'), data=df.nospr, method = "ML"))
```

Adding condition as fixed effect:
```{r}
summary(m2 <- bam(rightedge.lag ~ s(subj, bs='re') + condition, data=df.nospr, method = "ML"))
compareML(m, m2)
```

Adding group as fixed effect:
```{r}
summary(m3 <- bam(rightedge.lag ~ s(subj, bs='re') + condition + group, data=df.nospr, method = "ML"))
compareML(m2, m3)
```

Adding interaction:
```{r}
summary(m4 <- bam(rightedge.lag ~ s(subj, bs='re') + condition*group, data=df.nospr, method = "ML"))
compareML(m2, m4)
```

Adding random slopes for condition:
```{r}
summary(m5.REML <- bam(rightedge.lag ~ s(subj, bs='re') + condition*group + s(subj, condition, bs="re"), data=df.nospr, method = "REML"))
```


### Visualize final model:
```{r}
#using visreg: https://pbreheny.github.io/visreg/index.html

summary(m4.REML <- bam(rightedge.lag ~ s(subj, bs='re') + condition*group, data=df.nospr, method = "REML"))
gam.check(m4.REML) # right skewed -> fit wit loglink

summary(m4.REML.loglink <- bam(rightedge.lag ~ s(subj, bs='re') + condition*group, data=df.nospr, method = "REML", family =Gamma(link=log)))
gam.check(m4.REML.loglink) # doesn't improve


# visualize without specifying the interaction
visreg(m4.REML, "condition", by = "group", overlay = F, points = list(cex = 0.1), ylab = "time lag (ms)", gg=TRUE) + theme_bw()


# ggplot
visreg(m4.REML, "condition", overlay = T, points = list(cex = 0.1), ylab = "time lag (ms)", cond=list(group = "PD"), gg=TRUE) + theme_bw()
```

## Exploratory analysis
Adding cluster as fixed effect:
```{r}
summary(m5 <- bam(rightedge.lag ~ s(subj, bs='re') + condition*group, data=df.nospr, method = "ML"))
summary(m6 <- bam(rightedge.lag ~ s(subj, bs='re') + cluster + condition*group, data=df.nospr, method = "ML"))
compareML(m5, m6)
```

Adding cluster as random effect:
```{r}
summary(m7.REML <- bam(rightedge.lag ~ s(subj, bs='re') + cluster + condition*group + s(subj, cluster, bs="re"), data=df.nospr, method = "REML"))
```

Adding condition*cluster as fixed effect:
```{r}
summary(m7.ML <- bam(rightedge.lag ~ s(subj, bs='re') + cluster + condition*group, data=df.nospr, method = "ML"))
summary(m8.ML <- bam(rightedge.lag ~ s(subj, bs='re') + condition*cluster + condition*group, data=df.nospr, method = "ML"))
compareML(m7.ML, m8.ML)
```
Not sign at alpha = 0.01 level.

Adding cluster*group as fixed effect:
```{r}
summary(m9.ML <- bam(rightedge.lag ~ s(subj, bs='re') + group*cluster + condition*group, data=df.nospr, method = "ML"))
compareML(m7.ML, m9.ML)
```

Adding group*condition as fixed effect:
```{r}
summary(m10.ML <- bam(rightedge.lag ~ s(subj, bs='re') + condition*cluster*group, data=df.nospr, method = "ML"))
compareML(m10.ML, m9.ML)
```

Add speechrate
```{r}
summary(m11.ML <- bam(rightedge.lag ~ s(subj, bs='re') + s(duration.tt) + group*cluster + condition*group, data=df.nospr, method = "ML"))
compareML(m9.ML, m11.ML)
```

Add recording.no
```{r}
summary(m12.ML <- bam(rightedge.lag ~ s(subj, bs='re') + s(recording.no) + s(duration.tt)  + group*cluster + condition*group, data=df.nospr, method = "ML"))
compareML(m11.ML, m12.ML)
```

Add gender
```{r}
summary(m13.ML <- bam(rightedge.lag ~ s(subj, bs='re') + gender + s(duration.tt)  + group*cluster + condition*group, data=df.nospr, method = "ML"))
compareML(m11.ML, m13.ML)
```


Add dialect
```{r}
summary(m14.ML <- bam(rightedge.lag ~ s(subj, bs='re') + dialect + s(duration.tt) + group*cluster + condition*group, data=df.nospr, method = "ML"))
compareML(m11.ML, m14.ML)
```


Add age
```{r}
summary(m15.ML <- bam(rightedge.lag ~ s(subj, bs='re') + s(age) + s(duration.tt) + group*cluster + condition*group, data=df.nospr, method = "ML"))
compareML(m11.ML, m15.ML)
```

Add random slopes for speech rate
```{r}
summary(m16.REML <- bam(rightedge.lag ~ s(subj, bs='re') + s(age) + s(duration.tt)  + group*cluster + condition*group + s(subj, duration.tt, bs="re"), data=df.nospr, method = "REML"))
```

Add random slopes for cluster
```{r}
summary(m17.REML <- bam(rightedge.lag ~ s(subj, bs='re') + s(age) + s(duration.tt)  + group*cluster + condition*group + s(subj, cluster, bs="re"), data=df.nospr, method = "REML"))
```





### Checking assumptions
```{r}
summary(m11.REML <- bam(rightedge.lag ~ s(subj, bs='re') + s(duration.tt) + group*cluster + condition*group, data=df.nospr, method = "REML"))
gam.check(m11.REML) #looks excellent

visreg(m11.REML, "condition", by = "cluster", overlay = F, points = list(cex = 0.1), ylab = "lag (ms)", xlab = "item pair", cond=list(group = "typical"), gg=TRUE) + theme_bw() +
 ylim(125, 240)
visreg(m11.REML, "condition", by = "cluster", overlay = F, points = list(cex = 0.1), ylab = "lag (ms)", xlab = "item pair", cond=list(group = "PD"), gg=TRUE) + theme_bw() +
  ylim(125, 240)

plot_smooth(m11.REML, view='duration.tt', xlab="speech rate", ylab = "lag (ms)", rug = F)
```

# Session info
```{r}
sessionInfo()
```

